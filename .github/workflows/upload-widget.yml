name: Upload Widget to Blob Storage
on:
  workflow_run:
    workflows: ["Deploy to NuxtHub"]
    types:
      - completed
    branches:
      - main
      - master
      - services-api

  # Allow manual trigger with environment selection
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to upload widget to'
        required: true
        default: 'preview'
        type: choice
        options:
          - production
          - preview

jobs:
  upload-widget:
    name: "Upload Widget to Blob Storage"
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    # Only run if the deployment was successful or manually triggered
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    # Use environment for manual triggers, default to preview for automatic
    environment: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.environment || 'preview' }}

    steps:
      - uses: actions/checkout@v4

      - name: Wait for deployment to be ready
        if: ${{ github.event.workflow_run.conclusion == 'success' }}
        run: |
          echo "Waiting 30 seconds for deployment to stabilize..."
          sleep 30

      - name: Upload widget to blob storage
        id: upload
        run: |
          echo "Uploading widget to blob storage (${{ github.event_name == 'workflow_dispatch' && github.event.inputs.environment || 'preview' }} environment)..."

          # Environment-specific URLs and tokens are automatically available from GitHub environments
          BASE_URL="${{ vars.CREATE_STUDIO_BASE_URL || secrets.CREATE_STUDIO_BASE_URL || 'https://preview.create.studio' }}"
          CI_TOKEN="${{ secrets.CI_UPLOAD_TOKEN }}"

          # Call the CI upload-widget endpoint with authentication
          if [ -n "$CI_TOKEN" ]; then
            RESPONSE=$(curl -X POST \
              -H "Content-Type: application/json" \
              -H "X-CI-Token: $CI_TOKEN" \
              -H "User-Agent: GitHub-Actions-CreateStudio-CI/1.0" \
              -w "\n%{http_code}" \
              -s \
              "$BASE_URL/api/upload-widget-ci")
          else
            # Fallback to regular endpoint if no token configured
            RESPONSE=$(curl -X POST \
              -H "Content-Type: application/json" \
              -H "User-Agent: GitHub-Actions-CreateStudio-CI/1.0" \
              -w "\n%{http_code}" \
              -s \
              "$BASE_URL/api/upload-widget-ci")
          fi

          HTTP_CODE=$(echo "$RESPONSE" | tail -n 1)
          BODY=$(echo "$RESPONSE" | head -n -1)

          echo "Response: $BODY"
          echo "HTTP Code: $HTTP_CODE"

          if [ "$HTTP_CODE" != "200" ]; then
            echo "::error::Widget upload failed with HTTP $HTTP_CODE"
            exit 1
          fi

          echo "âœ… Widget uploaded successfully!"

      - name: Verify widget accessibility
        run: |
          echo "Verifying widget is accessible..."

          BASE_URL="${{ vars.CREATE_STUDIO_BASE_URL || secrets.CREATE_STUDIO_BASE_URL || 'https://preview.create.studio' }}"
          WIDGET_URL="$BASE_URL/embed/create-studio.iife.js"

          # Check if widget is accessible
          if curl -f -s "$WIDGET_URL" > /dev/null 2>&1; then
            echo "âœ… Widget is accessible at: $WIDGET_URL"

            # Get file size for verification
            SIZE=$(curl -sI "$WIDGET_URL" | grep -i content-length | awk '{print $2}' | tr -d '\r')
            if [ -n "$SIZE" ]; then
              echo "ðŸ“¦ Widget size: $((SIZE / 1024)) KB"
            fi
          else
            echo "::error::Widget is not accessible at $WIDGET_URL"
            exit 1
          fi


      - name: Summary
        if: always()
        run: |
          echo "## Widget Upload Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          BASE_URL="${{ vars.CREATE_STUDIO_BASE_URL || secrets.CREATE_STUDIO_BASE_URL || 'https://preview.create.studio' }}"
          ENVIRONMENT="${{ github.event_name == 'workflow_dispatch' && github.event.inputs.environment || 'preview' }}"

          if [ "${{ steps.upload.outcome }}" == "success" ]; then
            echo "âœ… **Widget uploaded successfully**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- Environment: **$ENVIRONMENT**" >> $GITHUB_STEP_SUMMARY
            echo "- Widget URL: \`$BASE_URL/embed/create-studio.iife.js\`" >> $GITHUB_STEP_SUMMARY
            echo "- Trigger: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
            if [ "${{ github.event_name }}" == "workflow_run" ]; then
              echo "- Triggered by: ${{ github.event.workflow_run.name }}" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "âŒ **Widget upload failed**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Please check the logs for more details." >> $GITHUB_STEP_SUMMARY
          fi